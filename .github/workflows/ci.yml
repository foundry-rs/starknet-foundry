name: CI

on:
  pull_request:
  merge_group:

jobs:
  test:
    name: test ${{ matrix.runner.name }}
    runs-on: ${{ matrix.os.runner }}
    strategy:
      matrix:
          # TODO: do we want macs as well?
          os : [{runner: ubuntu-latest, name: linux x86-64 }, {runner: windows-latest, name: windows x86-64 }]
          crate: ['test-collector', 'forge', 'cast']
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --manifest-path ./starknet-foundry/Cargo.toml -p ${{ matrix.crate }}

  rustfmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check forge formatting
        run: cargo fmt --manifest-path ./starknet-foundry/Cargo.toml --check -p forge
      - name: Check cast formatting
        run: cargo fmt --manifest-path ./starknet-foundry/Cargo.toml --check -p cast
      - name: Check test-collector formatting
        run: cargo fmt --manifest-path ./starknet-foundry/Cargo.toml --check -p test-collector

  clippy:
    runs-on: ubuntu-latest
    env:
      # Make sure CI fails on all warnings, including Clippy lints.
      RUSTFLAGS: "-Dwarnings"
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --manifest-path ./starknet-foundry/Cargo.toml --all-targets --all-features -- --no-deps
